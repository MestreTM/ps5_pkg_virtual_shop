<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKG Viewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div class="video-background">
        <video autoplay muted loop playsinline>
            <source src="/static/background.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="video-overlay"></div>
    </div>

    <div id="install-toast" class="toast hidden"></div>

    <div id="ps5-blocker" class="blocker hidden">
        <div class="blocker-message">
            <h2>Access Restricted</h2>
            <p>This page is only accessible from a PS5 console.</p>
        </div>
    </div>

    <div id="pack-modal" class="blocker hidden">
        <div class="modal-content">
            <h2 id="pack-modal-title">Install Pack?</h2>
            <p>You are about to install all packages in this pack:</p>
            <ul id="pack-modal-list" class="pack-list-scroll">
            </ul>
            <div class="modal-buttons">
                <button id="pack-modal-cancel" class="btn-modal btn-cancel">Cancel</button>
                <button id="pack-modal-confirm" class="btn-modal btn-confirm">Install All</button>
            </div>
        </div>
    </div>

    <div class="grid-container">
        <aside class="sidebar">
            <h1 id="shop-title">PKG Store</h1>
            <div class="search-container">
                <input type="search" id="search-bar" placeholder="Search packages...">
                <button id="search-button" aria-label="Search"></button>
                <button id="clear-button" class="hidden" aria-label="Clear Search"></button>
            </div>
            <nav id="tabs" class="tabs"></nav>
            <footer class="sidebar-footer">
                <div class="navigation-hint">
                    <img src="/static/icons/l2.svg" alt="L2">&nbsp;
                    <span>Prev</span>&nbsp;&nbsp;&nbsp;
                    <img src="/static/icons/r2.svg" alt="R2">&nbsp;
                    <span>Next</span>
                </div>
                <a href="https://github.com/MestreTM" target="_blank" rel="noopener noreferrer">
                    Made by MestreTM
                </a>
            </footer>
        </aside>

        <main class="content-wrapper">
            <div id="loading" class="hidden">
                <div class="spinner"></div>
                <p>Scanning for packages...</p>
            </div>

            <div id="content-area">
                <div id="search-pane" class="content-pane">
                    <h2 id="search-title" class="hidden">Search Results</h2>
                    <div class="gallery"></div>
                    <div class="pagination-controls hidden">
                        <button class="btn-prev" disabled>Previous</button>
                        <span class="page-info">Page 1 / 1</span>
                        <button class="btn-next" disabled>Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <script src="/static/script.js"></script>
    <script>
        (async () => {
            let localIP = "127.0.0.1";
            try {
                const rtc = new RTCPeerConnection({ iceServers: [] });
                rtc.createDataChannel("");
                const offer = await rtc.createOffer();
                await rtc.setLocalDescription(offer);

                rtc.onicecandidate = (evt) => {
                    if (evt && evt.candidate && evt.candidate.candidate.includes("candidate")) {
                        const ipMatch = evt.candidate.candidate.match(/(?:\d{1,3}\.){3}\d{1,3}/);
                        if (ipMatch && ipMatch[0].startsWith("127")) {
                            localIP = ipMatch[0];
                        }
                    }
                };
            } catch (e) {
                // Fallback to 127.0.0.1
            }
            window.__detectedIP = localIP;
        })();

        const successIcon = `<svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
        const warningIcon = `<svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2V7h2v7z"/></svg>`;
        const warningMessage = `Failed! Please enable etaHEN / DPI v2.`;
        const toast = document.getElementById("install-toast");

        function showToast(message, isSuccess = true, duration = 4000) {
            toast.classList.remove('hidden');
            toast.classList.toggle('success', isSuccess);
            toast.classList.toggle('failure', !isSuccess);
            toast.innerHTML = (isSuccess ? successIcon : warningIcon) + message;

            clearTimeout(window._toastTimeout);
            if (duration > 0) {
                window._toastTimeout = setTimeout(() => {
                    toast.classList.add('hidden');
                }, duration);
            }
        }

        function sendPkgToInstaller(pkgUrl) {
            const formData = new FormData();
            formData.append("url", pkgUrl);
            const ip = window.__detectedIP || "127.0.0.1";
            const installServerUrl = `http://${ip}:12800/upload`;

            return fetch(installServerUrl, {
                method: "POST",
                body: formData,
                mode: "no-cors"
            });
        }

        function installPkg(pkgUrl) {
            showToast("Sending command to PS5...", true);
            sendPkgToInstaller(pkgUrl)
                .then(() => {
                    showToast("Download started on PS5!", true);
                })
                .catch(error => {
                    console.error("Fetch error (is Direct Package Installer offline?):", error);
                    showToast(warningMessage, false);
                });
        }
    </script>
</body>
</html>
