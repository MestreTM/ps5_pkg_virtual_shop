<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKG Viewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div id="install-toast" class="toast hidden"></div>

    <div id="ps5-blocker" class="blocker hidden">
        <div class="blocker-message">
            <h2>Access Restricted</h2>
            <p>This page is only accessible from a PS5 console.</p>
        </div>
    </div>

    <div id="pack-modal" class="blocker hidden">
        <div class="modal-content">
            <h2 id="pack-modal-title">Install Pack?</h2>
            <p>You are about to install all packages in this pack:</p>
            <ul id="pack-modal-list" class="pack-list-scroll">
            </ul>
            <div class="modal-buttons">
                <button id="pack-modal-cancel" class="btn-modal btn-cancel">Cancel</button>
                <button id="pack-modal-confirm" class="btn-modal btn-confirm">Install All</button>
            </div>
        </div>
    </div>

    <header>
        <h1 id="shop-title">PKG Viewer</h1>
        <div class="search-container">
            <input type="search" id="search-bar" placeholder="Search packages by title...">
        </div>
        <nav id="tabs" class="tabs"></nav>
    </header>

    <div id="loading" class="hidden">
        <div class="spinner"></div>
        <p>Scanning... This might take a moment on the first run.</p>
    </div>

    <main id="content-area">
    </main>

    <footer>
        <div class="navigation-hint">
		    <img src="/static/icons/left.svg" alt="L2 Button Icon">&nbsp;
            <img src="/static/icons/l2.svg" alt="L2 Button Icon">&nbsp;&nbsp;&nbsp;
            <img src="/static//icons/r2.svg" alt="R2 Button Icon">&nbsp;
			<img src="/static/icons/right.svg" alt="L2 Button Icon">&nbsp;
        </div>
        <div class="footer-content">
            <a href="https://github.com/MestreTM" target="_blank" rel="noopener noreferrer">
                <svg class="coffee-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.5 3H6c-1.1 0-2 .9-2 2v5.71c0 3.31 2.69 6 6 6h2v1h-2c-.55 0-1 .45-1 1s.45 1 1 1h4c.55 0 1-.45 1-1s-.45-1-1-1h-2v-1h2c3.31 0 6-2.69 6-6V5c0-1.1-.9-2-2-2zm-1.5 8.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5zM20 5v3h-2V5h2z"/></svg>
                <span>Made by MestreTM</span>
            </a>
        </div>
    </footer>

    <script src="/static/script.js"></script>
    <script>
        (async () => {
            let localIP = "127.0.0.1";
            try {
                const rtc = new RTCPeerConnection({ iceServers: [] });
                rtc.createDataChannel("");
                const offer = await rtc.createOffer();
                await rtc.setLocalDescription(offer);
                
                rtc.onicecandidate = (evt) => {
                    if (evt && evt.candidate && evt.candidate.candidate.includes("candidate")) {
                        const ipMatch = evt.candidate.candidate.match(/(?:\d{1,3}\.){3}\d{1,3}/);
                        if (ipMatch && ipMatch[0].startsWith("127")) {
                            localIP = ipMatch[0];
                        }
                    }
                };
            } catch (e) {
                // Fallback to 127.0.0.1
            }
            window.__detectedIP = localIP;
        })();

        const successIcon = `<svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;" xmlns="http://www.w3.org/2000/svg"><path fill="#00cc66" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
        const warningIcon = `<svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 6px;" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#FFCC00"/></svg>`;
        const warningMessage = `Failed! Please enable etaHEN / DPI v2.`;
        const toast = document.getElementById("install-toast");
        
        function showToast(message, isSuccess = true) {
            toast.classList.remove('hidden');
            toast.classList.toggle('success', isSuccess);
            toast.classList.toggle('failure', !isSuccess);
            toast.innerHTML = (isSuccess ? successIcon : warningIcon) + message;

            clearTimeout(window._toastTimeout);
            window._toastTimeout = setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }

        function sendPkgToInstaller(pkgUrl) {
            const formData = new FormData();
            formData.append("url", pkgUrl); 
            const ip = window.__detectedIP || "127.0.0.1";
            const installServerUrl = `http://${ip}:12800/upload`;

            return fetch(installServerUrl, { 
                method: "POST", 
                body: formData, 
                mode: "no-cors" 
            });
        }

        function installPkg(pkgUrl) {
            showToast("Sending command to PS5...", true);
            sendPkgToInstaller(pkgUrl)
                .then(() => {
                    showToast("Download started on PS5!", true);
                })
                .catch(error => {
                    console.error("Fetch error (is Direct Package Installer offline?):", error);
                    showToast(warningMessage, false);
                });
        }
    </script>
</body>
</html>
